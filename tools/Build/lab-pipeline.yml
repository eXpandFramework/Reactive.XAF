# https://aka.ms/yaml
name: 18.2.400$(Rev:.rr)
resources:
- repo: self
trigger:
- lab
queue:
  name: Hosted VS2017
  demands: 
  - msbuild
  - visualstudio
variables:
  eXpandFramework: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
  issueNotifierPipeline: 26
steps:
- task: DownloadBuildArtifacts@0
  displayName: 'Download VersionUpdater Artifacts'
  enabled: true
  inputs:
    buildType: specific
    project: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
    pipeline: 28
    artifactName: VersionUpdater
- task: DotNetCoreInstaller@0
  displayName: 'Use .NET Core runtime 2.2.0'
  inputs:
    packageType: runtime
    version: 2.2.0
- powershell: |
   $packages=(& $(System.DefaultWorkingDirectory)\Tools\Nuget.exe list -source "https://xpandnugetserver.azurewebsites.net/nuget"|where{$_ -like "DevExpress.XAF*"}|foreach{$_.Replace(" ",";")}) -join ":"
   & "$(build.artifactstagingdirectory)\VersionUpdater\VersionUpdater.exe" -o $(GitHubUserName) -z eXpandFramework --r1 eXpand --r2 Packages -b lab -p $(GithubPass) -d $(System.DefaultworkingDirectory) -n $packages
    .\go.ps1 -msbuild "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin\msbuild.exe" -packageSources $(DXApiFeed) 
  displayName: 'Build'
  failOnStderr: true
- task: VSTest@2
  displayName: 'VsTest - testAssemblies'
  enabled: true
  inputs:
    testAssemblyVer2: |
     .\bin\DevExpress.XAF.Agnostic.Specifications.dll
    uiTests: true
    runInParallel: false
    diagnosticsEnabled: false
    runTestsInIsolation: true
    codeCoverageEnabled: true
    rerunFailedTests: true
- task: NuGetCommand@2
  displayName: 'NuGet push'
  enabled: true
  inputs:
    command: push
    packagesToPush: '$(System.DefaultWorkingDirectory)/bin/nuget/*.nupkg'
    nuGetFeedType: external
    publishFeedCredentials: XpandNugetServer
    allowPackageConflicts: true
- task: DownloadBuildArtifacts@0
  displayName: 'Download IssueNotifier Build Artifacts'
  inputs:
    buildType: specific
    project: $(eXpandFramework)
    pipeline: $(issueNotifierPipeline)
    artifactName: IssueNotifier
- powershell: | 
     $msg="{Commits} relates to this task. Please update your nuget packages to version {Options.Version} and test if it addresses the problem.`r`n To access the lab packages you need to add our [NugetServer]({Options.NugetServer}) as a nuget package source in VS.`r`n If these packages are already integrated with `eXpandFramework` the bot will notify this issue again as soon as the release is ready."
     & "$(build.artifactstagingdirectory)\IssueNotifier\IssueNotifier.exe" -o $(GitHubUserName) -z eXpandFramework --r1 eXpand --r2 Packages -b lab -p $(githubpass) -v $(Build.BuildNumber) --msg $msg
  displayName: 'IssueNotifier'
  failOnStderr: true
- task: PublishPipelineArtifact@0
  displayName: 'Publish Pipeline Artifact'
  inputs:
    artifactName: Packages
    targetPath: bin/nuget




