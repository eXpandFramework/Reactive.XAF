# https://aka.ms/yaml
variables:
  - group: Keys
trigger: 
  paths:
    exclude:
      - .github/FUNDING.yml
      - src/Modules/Readme.md
      - src/Modules/AutoCommit/Readme.md
      - src/Modules/CloneMemberValue/Readme.md
      - src/Modules/HideToolBar/Readme.md
      - src/Modules/MasterDetail/Readme.md
      - src/Modules/ModelMapper/Readme.md
      - src/Modules/ModelViewInheritance/Readme.md
      - src/Modules/ProgressBarViewItem/Readme.md
      - src/Modules/Reactive/Readme.md
      - src/Modules/SuppressConfirmation/Readme.md
      - src/Modules/ViewEditMode/Readme.md
      - README.md
  branches:
    include:
      - lab
pool:
  vmImage: windows-2019
steps:
- checkout: self
  clean: true
- task: PowerShell@2
  displayName: Build
  inputs:
    pwsh: true
    targetType: filePath
    filePath: .\tools\build\lab-pipeline.ps1 
    arguments: $(Build.SourceBranchName) $(System.DefaultworkingDirectory) $(GitHubUserName) $(GitHubPass) $(DXApiFeed) $(build.artifactstagingdirectory) $(AzureToken)
- task: VSTest@2
  displayName: 'VsTest - testAssemblies'
  enabled: true
  inputs:
    searchFolder: '$(System.DefaultWorkingDirectory)'
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\*Tests*.dll
      !**\*TestAdapter.dll
      !**\obj\**
    runInParallel: false
    diagnosticsEnabled: true
    runTestsInIsolation: false
    codeCoverageEnabled: true
    rerunFailedTests: true 
    rerunMaxAttempts: 3
    collectDumpOn: never
    
    
- task: PowerShell@2
  displayName: CheckTests
  inputs:
    pwsh: true
    targetType: filePath
    filePath: .\tools\build\check-tests.ps1
    arguments: $(AzureToken) $(Build.DefinitionName) $(Build.BuildNumber)
- powershell: | 
- task: PowerShell@2
  displayName: Publish
  inputs:
    pwsh: true
    targetType: filePath
    filePath: .\tools\build\publishNugets.ps1 
    arguments: $(Build.SourceBranchName) $(System.DefaultworkingDirectory) $(NugetApiKey) 
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: Packages'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'
    ArtifactName: 'Xpand.XAF.Modules.Packages'
